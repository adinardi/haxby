#!/usr/bin/env bash

# Major portions of logic below inspired by https://github.com/jayferd/balls
#  Primarily the rough idea for finding the lib directory
#  Also the method naming and mode function calling

set -e

# BSD readlink does not work with the args used in haxby
if readlink -f >/dev/null 2>&1
then
    # System has gnu coreutils (probably)
    : # noop
elif which greadlink >/dev/null 2>&1
then
    # System as gnu coreutils installed, but to alternate names
    function readlink {
        greadlink $@
    }
elif python -c 'import os,sys;print os.path.realpath(sys.argv[1])' / >/dev/null 2>&1
then
    # System has no coreutils, use python
    function readlink {
        shift # Python does not need the -f option
        python -c 'import os,sys;print os.path.realpath(sys.argv[1])' $@
    }
else
    echo "No usable method to discover canonical path found, exiting"
    exit 1
fi

function haxby::bin::search-conf-git {
    HAXBY_CONF=$(find $GIT_ROOT -name 'haxby.conf')
    CONF_COUNT=$(wc -l <<<$HAXBY_CONF)
    if [ "$CONF_COUNT" -gt "1" ]; then
        echo "Found more than one 'haxby.conf', failed auto-conf"
        exit 1
    elif [ "$CONF_COUNT" -eq "0" ]; then
        echo "No config was auto-discovered, exiting"
        exit 1
    fi
    echo $HAXBY_CONF
}

function haxby::bin::load-conf {
    GIT_ROOT=$(git rev-parse --show-toplevel || true)
    [[ -n "$GIT_ROOT" ]] && HAXBY_CONF=$(haxby::bin::search-conf-git)

    [[ -z "$HAXBY_CONF" ]] && { echo "Config auto-discovery failed, exiting"; exit 1; }

    [[ -n "$HAXBY_CONF" ]] && HAXBY_CONF=$(readlink -f $HAXBY_CONF)
    [[ -n "$HAXBY_CONF" ]] && HAXBY_CONF_DIR=$(dirname $HAXBY_CONF)
    [[ -n "$HAXBY_CONF" ]] && . "$HAXBY_CONF"
}

function haxby::bin::check-installed-lib {
    HAXBY_LIB=$(dirname $0)/../share/haxby
    HAXBY_LIB=$(readlink -f "$HAXBY_LIB")
    . $HAXBY_LIB/haxby.sh || { echo "Failed to find lib directory"; exit 1; }
}

function haxby::bin::load-lib {
    HAXBY_LIB=$(dirname $0)/../lib
    HAXBY_LIB=$(readlink -f "$HAXBY_LIB")
    . $HAXBY_LIB/haxby.sh 2>/dev/null || haxby::bin::check-installed-lib
}

mode=$1
shift

haxby::bin::load-conf
haxby::bin::load-lib

for haxby_mode in $HAXBY_MODES
do
    if [ "$haxby_mode" == "$mode" ]; then
        haxby::lib::$mode $@
        exit $?
    fi
done

echo "Unknown Mode"
echo "Supported Modes: $HAXBY_MODES"
exit 1
