#!/usr/bin/env bash

# Major portions of logic below inspired by https://github.com/jayferd/balls

HAXBY_LIB=$(dirname $0)/../lib
if which greadlink >/dev/null 2>&1
then
    function readlink {
        greadlink $@
    }
fi
HAXBY_LIB=$(readlink -f "$HAXBY_LIB")

mode=$1
shift

function haxby::search-conf {
    HAXBY_CONF=$(find $GIT_ROOT -name 'haxby.conf')
    CONF_COUNT=$(wc -l <<<$HAXBY_CONF)
    if [ "$CONF_COUNT" -gt "1" ]; then
        echo "Found more than one 'haxby.conf', failed auto-conf"
        unset HAXBY_CONF
    elif [ "$CONF_COUNT" -eq "0" ]; then
        echo "No config was auto-discovered or specified, exiting"
        exit 1
    fi
    echo $HAXBY_CONF
}

if [ -z "$HAXBY_SKIP_AUTO" ]; then
    GIT_ROOT=$(git rev-parse --show-toplevel || true)
    [[ -n "$GIT_ROOT" ]] && HAXBY_CONF=$(haxby::search-conf)
fi

[[ -n "$HAXBY_CONF" ]] && HAXBY_CONF=$(readlink -f $HAXBY_CONF)
[[ -n "$HAXBY_CONF" ]] && HAXBY_CONF_DIR=$(dirname $HAXBY_CONF)
[[ -n "$HAXBY_CONF" ]] && . "$HAXBY_CONF"

function check_if_installed {
    HAXBY_LIB=$(dirname $0)/../share/haxby
    HAXBY_LIB=$(readlink -f "$HAXBY_LIB")
    . $HAXBY_LIB/haxby.sh || { echo "Failed to find lib directory"; exit 1; }
}

. $HAXBY_LIB/haxby.sh 2>/dev/null || check_if_installed

for haxby_mode in $HAXBY_MODES
do
    if [ "$haxby_mode" == "$mode" ]; then
        haxby::$mode $@
        exit $?
    fi
done

echo "Unknown Mode"
echo "Supported Modes: $HAXBY_MODES"
exit 1
